<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud - Usage Dashboard</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      --success:#28a745; --info:#17a2b8; --chart-blue:#4e73df; --chart-green:#1cc88a;
      --chart-yellow:#f6c23e; --chart-red:#e74a3b; --chart-purple:#6f42c1;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:0; padding:0;
      background:var(--light-bg);color:var(--text-color);
      line-height:1.6;
    }

    .container{
      max-width:none;
      margin:0 20px;
      width:calc(100% - 40px);
    }
    
    header{
      background:var(--card-bg);border-radius:12px;padding:28px 36px;
      margin-bottom:28px;box-shadow:0 2px 8px rgba(0,0,0,.08);
      border-left:5px solid var(--primary-color);border:1px solid var(--border-color);
      margin-top:20px;
    }

    h1{color:var(--text-color);margin-bottom:12px;font-size:32px;font-weight:600;}
    .subtitle{color:var(--text-light);font-size:17px;}
    
    @media(max-width:1200px){
      .container{margin:0 15px;width:calc(100% - 30px);}
    }

    .card{
      background:var(--card-bg);border:1px solid var(--border-color);
      border-radius:14px;padding:28px;margin-bottom:20px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }

    .card h2{
      color:var(--primary-color);margin-bottom:24px;font-size:22px;
      padding-bottom:16px;border-bottom:2px solid var(--light-bg);
      display:flex;align-items:center;gap:12px;
      font-weight:600;
    }

    .form-group{margin-bottom:24px}
    label{display:block;font-weight:600;margin-bottom:8px;color:var(--text-color);font-size:14px;}
    select,input,button{
      padding:12px;border:1px solid var(--border-color);
      border-radius:8px;background:var(--card-bg);font-size:15px;width:100%;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s;border:none;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      font-size:15px;
    }

    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .btn-block{width:100%;padding:14px}
    
    .status-container{
      position:fixed;top:20px;right:20px;z-index:1000;
      display:flex;flex-direction:column;gap:10px;
      max-width:400px;
    }

    .status-message{
      background:white;padding:16px;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:4px solid var(--primary-color);
      animation:slideIn 0.3s ease-out;display:flex;align-items:center;gap:12px;
    }

    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }

    .table-container{
      overflow-x:auto;margin-top:24px;border-radius:10px;
      border:1px solid var(--border-color);background:var(--card-bg);
      max-height:600px;overflow-y:auto;
    }

    table{width:100%;border-collapse:collapse}
    th{
      background-color:var(--primary-color);color:white;font-weight:600;
      position:sticky;top:0;z-index:10;white-space:nowrap;padding:18px;text-align:center;
      font-size:14px;
    }
    td{padding:16px 18px;border-bottom:1px solid var(--border-color);font-size:14px;text-align:center;}
    tr:hover{background-color:var(--pill)}

    .tabs{
      display:flex;border-bottom:2px solid var(--border-color);
      margin-bottom:28px;background:white;border-radius:10px 10px 0 0;
    }

    .tab{
      padding:18px 28px;background:none;border:none;
      border-bottom:2px solid transparent;font-size:16px;
      font-weight:600;color:var(--text-light);cursor:pointer;
      transition:all 0.3s;flex:1;text-align:center;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    .tab:hover{color:var(--primary-color)}
    .tab.active{
      color:var(--primary-color);border-bottom-color:var(--primary-color);
      background:rgba(99,171,143,0.05);
    }

    .tab-content{display:none;animation:fadeIn 0.3s ease}
    .tab-content.active{display:block}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .loading-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);display:flex;
      flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;display:none;
    }

    .loading-overlay.active{display:flex}
    .spinner{
      width:60px;height:60px;border:5px solid #f3f3f3;
      border-top:5px solid var(--primary-color);border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:20px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:768px){
      body{margin:10px;padding:0}
      .card{padding:20px}
      header{padding:20px;margin-top:10px;}
      h1{font-size:28px}
      .btn-block{padding:12px 18px;font-size:15px}
      .container{margin:0 10px;width:calc(100% - 20px);}
    }

    /* METRIC TILE STYLES */
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .metric-card {
      background: white;
      border-radius: 14px;
      padding: 24px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      border-color: var(--primary-color);
    }
    
    .metric-card.warning {
      border-left: 5px solid var(--warning);
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.05), rgba(255, 193, 7, 0.02));
    }
    
    .metric-card.danger {
      border-left: 5px solid var(--danger);
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.05), rgba(220, 53, 69, 0.02));
    }
    
    .metric-card.success {
      border-left: 5px solid var(--success);
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.05), rgba(40, 167, 69, 0.02));
    }
    
    .metric-card.info {
      border-left: 5px solid var(--info);
      background: linear-gradient(135deg, rgba(23, 162, 184, 0.05), rgba(23, 162, 184, 0.02));
    }
    
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .metric-icon {
      font-size: 24px;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .metric-card.warning .metric-icon {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning);
    }
    
    .metric-card.danger .metric-icon {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
    }
    
    .metric-card.success .metric-icon {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
    }
    
    .metric-card.info .metric-icon {
      background: rgba(23, 162, 184, 0.1);
      color: var(--info);
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 700;
      margin: 8px 0;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }
    
    .metric-label {
      font-size: 14px;
      color: var(--text-color);
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .metric-subtext {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 8px;
      line-height: 1.4;
    }
    
    .metric-change {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .change-positive {
      background: rgba(40, 167, 69, 0.15);
      color: var(--success);
    }
    
    .change-negative {
      background: rgba(220, 53, 69, 0.15);
      color: var(--danger);
    }
    
    .change-neutral {
      background: rgba(108, 117, 125, 0.15);
      color: var(--text-light);
    }
    
    /* Progress bar for transcription */
    .progress-container {
      margin-top: 16px;
    }
    
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 4px;
    }
    
    .progress-bar {
      height: 8px;
      background: var(--light-bg);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .progress-fill.prepaid {
      background: linear-gradient(90deg, var(--success), var(--chart-green));
    }
    
    .progress-fill.used {
      background: linear-gradient(90deg, var(--chart-blue), var(--primary-color));
    }
    
    .progress-fill.remaining {
      background: linear-gradient(90deg, var(--light-bg), var(--border-color));
    }
    
    /* Period selector */
    .period-selector {
      display: flex;
      gap: 12px;
      align-items: center;
      background: var(--pill);
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .period-option {
      flex: 1;
      text-align: center;
      padding: 12px;
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-color);
      transition: all 0.3s;
    }
    
    .period-option:hover {
      border-color: var(--primary-color);
      background: rgba(99, 171, 143, 0.05);
    }
    
    .period-option.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    /* Table styles */
    .category-header {
      background-color: var(--light-bg) !important;
      font-weight: 700;
      font-size: 16px;
      color: var(--text-color);
      border-top: 2px solid var(--border-color);
      border-bottom: 2px solid var(--border-color);
    }
    
    .category-header td {
      padding: 20px 18px;
      text-align: left !important;
    }
    
    .sub-item {
      padding-left: 40px !important;
      font-size: 13px;
      color: var(--text-light);
    }
    
    .sub-item td:first-child:before {
      content: "‚Ü≥ ";
      margin-right: 8px;
    }
    
    .total-row {
      background-color: var(--pill) !important;
      font-weight: 700;
      border-top: 2px solid var(--border-color);
    }
    
    .number-cell {
      font-family: 'Aptos', monospace;
    }
    
    .highlight-row {
      background-color: rgba(255, 193, 7, 0.1) !important;
      border-left: 3px solid var(--warning);
    }
    
    .highlight-row:hover {
      background-color: rgba(255, 193, 7, 0.2) !important;
    }
    
    .danger-row {
      background-color: rgba(220, 53, 69, 0.1) !important;
      border-left: 3px solid var(--danger);
    }
    
    .danger-row:hover {
      background-color: rgba(220, 53, 69, 0.2) !important;
    }
    
    .success-row {
      background-color: rgba(40, 167, 69, 0.1) !important;
      border-left: 3px solid var(--success);
    }
    
    .success-row:hover {
      background-color: rgba(40, 167, 69, 0.2) !important;
    }
    
    .compact-table th,
    .compact-table td {
      padding: 12px 16px;
      font-size: 13px;
    }
    
    .utilization-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .utilization-high { background-color: var(--danger); }
    .utilization-medium { background-color: var(--warning); }
    .utilization-low { background-color: var(--success); }
    
    .note {
      font-size: 12px;
      color: var(--text-light);
      font-style: italic;
      margin-top: 8px;
    }
    
    /* Column alignment fix */
    .text-left {
      text-align: left !important;
    }
    
    .text-center {
      text-align: center !important;
    }
    
    .text-right {
      text-align: right !important;
    }
    
    /* Auth styles */
    .auth-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    
    .auth-card {
      max-width: 400px;
      width: 90%;
      padding: 40px;
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    /* Color coding for utilization percentages */
    .utilization-high-text { color: var(--danger); font-weight: 600; }
    .utilization-medium-text { color: var(--warning); font-weight: 600; }
    .utilization-low-text { color: var(--success); font-weight: 600; }
  </style>
</head>
<body>
  <!-- Auth Container -->
  <div class="auth-container" id="authContainer">
    <div class="auth-card">
      <div style="font-size: 48px; margin-bottom: 20px;">üîê</div>
      <h2 style="margin-bottom: 16px;">Genesys Cloud Authentication</h2>
      <p style="color: var(--text-light); margin-bottom: 24px;">Connecting to trusted organization billing API...</p>
      <div class="spinner" style="margin: 0 auto;"></div>
    </div>
  </div>

  <div class="status-container" id="statusContainer"></div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:20px;font-weight:600;margin-bottom:12px;">Loading Usage Data...</div>
    <div id="loadingSubtext" style="font-size:15px;color:var(--text-light);text-align:center;max-width:500px;">Fetching Genesys Cloud usage information</div>
  </div>

  <!-- Main Content -->
  <div class="container" id="mainContent" style="display: none;">
    <header>
      <h1>üìä Genesys Cloud - Usage Dashboard</h1>
      <div class="subtitle" style="display:flex;justify-content:space-between;align-items:center;">
        <span id="orgNameDisplay">JLA Trusted Organization</span>
        <span id="lastUpdated" style="font-size:14px;background:var(--pill);padding:6px 12px;border-radius:20px;">Loading...</span>
      </div>
    </header>

    <!-- Period Selector -->
    <div class="period-selector">
      <div class="period-option active" data-period="0">Current Month</div>
      <div class="period-option" data-period="1">Last Month</div>
      <div class="period-option" data-period="2">Previous Month</div>
    </div>

    <!-- METRIC TILES -->
    <div class="metric-grid" id="metricTiles">
      <div class="metric-card info" id="metricTotalUsers">
        <div class="metric-header">
          <div>
            <div class="metric-label">Total User Licenses</div>
            <div class="metric-value" id="totalUsersValue">0</div>
          </div>
          <div class="metric-icon">üë•</div>
        </div>
        <div class="metric-subtext" id="usersUtilization">Loading...</div>
      </div>
      
      <div class="metric-card warning" id="metricUserOverage">
        <div class="metric-header">
          <div>
            <div class="metric-label">User Overage Risk</div>
            <div class="metric-value" id="overageRiskValue">0</div>
          </div>
          <div class="metric-icon">‚ö†Ô∏è</div>
        </div>
        <div class="metric-subtext" id="overageDetail">No overage detected</div>
      </div>
      
      <div class="metric-card success" id="metricSpeechAnalytics">
        <div class="metric-header">
          <div>
            <div class="metric-label">Speech Analytics Usage</div>
            <div class="metric-value" id="speechUsageValue">0%</div>
          </div>
          <div class="metric-icon">üé§</div>
        </div>
        <div class="progress-container">
          <div class="progress-label">
            <span>Used: <span id="speechUsed">0</span> min</span>
            <span>Prepaid: <span id="speechPrepaid">0</span> min</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill used" id="speechProgressUsed" style="width:0%"></div>
          </div>
        </div>
        <div class="metric-subtext" id="speechDetail">Transcription minutes utilization</div>
      </div>
      
      <div class="metric-card info" id="metricIVRUsage">
        <div class="metric-header">
          <div>
            <div class="metric-label">IVR Usage</div>
            <div class="metric-value" id="ivrUsageValue">0%</div>
          </div>
          <div class="metric-icon">üìû</div>
        </div>
        <div class="metric-subtext" id="ivrDetail">IVR minutes utilization</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="users">üë• User Licenses</button>
      <button class="tab" data-tab="resources">üì¶ Resources</button>
      <button class="tab" data-tab="highlights">‚ö†Ô∏è Usage Highlights</button>
    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="tab-content active">
      <div class="card">
        <h2>üë• User Licenses</h2>
        <div class="table-container">
          <table id="usersTable">
            <thead>
              <tr>
                <th class="text-left">Service Name</th>
                <th>Total Qty</th>
                <th>Committed</th>
                <th>Used</th>
                <th>On-Demand</th>
                <th>Utilization</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr><td colspan="7" style="text-align:center;padding:48px;color:var(--text-light);">
                Loading user data...
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Resources Tab -->
    <div id="tab-resources" class="tab-content">
      <div class="card">
        <h2>üì¶ Resources (excludes Cloud Voice charges)</h2>
        <div class="table-container">
          <table id="resourcesTable" class="compact-table">
            <thead>
              <tr>
                <th class="text-left">Resource Name</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Included</th>
                <th>Used</th>
                <th>On-Demand</th>
                <th>Utilization</th>
              </tr>
            </thead>
            <tbody id="resourcesTableBody">
              <tr><td colspan="7" style="text-align:center;padding:48px;color:var(--text-light);">
                Loading resource data...
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Highlights Tab -->
    <div id="tab-highlights" class="tab-content">
      <div class="card">
        <h2>‚ö†Ô∏è Usage Highlights & Alerts</h2>
        
        <!-- User License Highlights -->
        <div style="margin-bottom: 32px;">
          <h3 style="color: var(--primary-color); margin-bottom: 16px;">üë• User License Utilization</h3>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th class="text-left">License Type</th>
                  <th>Total</th>
                  <th>Committed</th>
                  <th>Used</th>
                  <th>On-Demand</th>
                  <th>Utilization</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="highlightsUsersTable">
                <tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-light);">
                  Analyzing user license data...
                </td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Speech Analytics Highlight -->
        <div style="margin-bottom: 32px;">
          <h3 style="color: var(--primary-color); margin-bottom: 16px;">üé§ Speech Analytics - Transcription Usage</h3>
          <div id="speechAnalyticsCard" class="metric-card" style="margin-bottom: 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Genesys Cloud for Voice Transcription Fair Use (Legacy)</div>
                <div style="font-size: 14px; color: var(--text-light);">Prepaid vs Used Analysis</div>
              </div>
              <div style="font-size: 24px;">üé§</div>
            </div>
            
            <div class="progress-container" style="margin-bottom: 20px;">
              <div class="progress-label">
                <span>Used: <span id="highlightSpeechUsed">0</span> min</span>
                <span>Prepaid: <span id="highlightSpeechPrepaid">0</span> min</span>
                <span>Remaining: <span id="highlightSpeechRemaining">0</span> min</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill used" id="highlightSpeechUsedBar" style="width:0%"></div>
                <div class="progress-fill remaining" id="highlightSpeechRemainingBar" style="width:100%"></div>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: var(--chart-blue);" id="highlightSpeechUsedPct">0%</div>
                <div style="font-size: 12px; color: var(--text-light);">Used</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="highlightSpeechAvailablePct">0%</div>
                <div style="font-size: 12px; color: var(--text-light);">Available</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: var(--text-light);" id="highlightSpeechDaysLeft">0</div>
                <div style="font-size: 12px; color: var(--text-light);">Days in Month</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resource Highlights -->
        <div>
          <h3 style="color: var(--primary-color); margin-bottom: 16px;">üìä Resource Usage Highlights</h3>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th class="text-left">Resource</th>
                  <th>Total</th>
                  <th>Used</th>
                  <th>Available</th>
                  <th>On-Demand</th>
                  <th>Utilization</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="highlightsResourcesTable">
                <tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-light);">
                  Analyzing resource usage...
                </td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions Card -->
    <div class="card" style="margin-top: 24px;">
      <h2>‚ö° Actions</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <button id="btnRefresh" class="btn btn-block">
          <span>üîÑ Refresh Data</span>
        </button>
        <button id="btnExportCSV" class="btn btn-block" style="background: var(--success);">
          <span>üìÑ Export CSV</span>
        </button>
        <button id="btnExportJSON" class="btn btn-block" style="background: var(--info);">
          <span>üîß Export JSON</span>
        </button>
        <button id="btnDisconnect" class="btn btn-block" style="background: var(--danger);">
          <span>üö™ Disconnect</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const CONFIG = {
      CLIENT_ID: '4ab97fe2-54c0-4deb-8b9a-a4b5720d6c67',
      REDIRECT_URI: window.location.origin + window.location.pathname,
      TRUSTED_ORG_ID: '9b6492f9-d751-4406-bc7a-8ed307afef0a',
      CUSTOMER_NAME: 'JLA',
      ENVIRONMENT_REGION: 'eu-west-2',
      ENVIRONMENTS: {
        'eu-west-2': { 
          name: 'EU West (London)', 
          api: 'https://api.euw2.pure.cloud', 
          login: 'https://login.euw2.pure.cloud' 
        }
      },
      STORAGE_KEYS: {
        TOKEN: 'gc_usage_token',
        TOKEN_EXPIRY: 'gc_usage_token_expiry',
        REFRESH_TOKEN: 'gc_usage_refresh_token'
      }
    };

    // ==================== STATE MANAGEMENT ====================
    let appState = {
      isAuthenticated: false,
      currentTab: 'users',
      currentPeriod: 0,
      usageData: null,
      rawApiData: null,
      lastFetchTime: null,
      billingHistory: {}
    };

    // ==================== DOM ELEMENTS ====================
    const el = {
      authContainer: document.getElementById('authContainer'),
      mainContent: document.getElementById('mainContent'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      statusContainer: document.getElementById('statusContainer'),
      lastUpdated: document.getElementById('lastUpdated'),
      orgNameDisplay: document.getElementById('orgNameDisplay'),
      
      // Metric tiles
      totalUsersValue: document.getElementById('totalUsersValue'),
      usersUtilization: document.getElementById('usersUtilization'),
      overageRiskValue: document.getElementById('overageRiskValue'),
      overageDetail: document.getElementById('overageDetail'),
      metricUserOverage: document.getElementById('metricUserOverage'),
      speechUsageValue: document.getElementById('speechUsageValue'),
      speechUsed: document.getElementById('speechUsed'),
      speechPrepaid: document.getElementById('speechPrepaid'),
      speechProgressUsed: document.getElementById('speechProgressUsed'),
      speechDetail: document.getElementById('speechDetail'),
      ivrUsageValue: document.getElementById('ivrUsageValue'),
      ivrDetail: document.getElementById('ivrDetail'),
      
      // Tables
      usersTableBody: document.getElementById('usersTableBody'),
      resourcesTableBody: document.getElementById('resourcesTableBody'),
      highlightsUsersTable: document.getElementById('highlightsUsersTable'),
      highlightsResourcesTable: document.getElementById('highlightsResourcesTable'),
      
      // Speech analytics highlights
      highlightSpeechUsed: document.getElementById('highlightSpeechUsed'),
      highlightSpeechPrepaid: document.getElementById('highlightSpeechPrepaid'),
      highlightSpeechRemaining: document.getElementById('highlightSpeechRemaining'),
      highlightSpeechUsedBar: document.getElementById('highlightSpeechUsedBar'),
      highlightSpeechRemainingBar: document.getElementById('highlightSpeechRemainingBar'),
      highlightSpeechUsedPct: document.getElementById('highlightSpeechUsedPct'),
      highlightSpeechAvailablePct: document.getElementById('highlightSpeechAvailablePct'),
      highlightSpeechDaysLeft: document.getElementById('highlightSpeechDaysLeft'),
      
      // Buttons
      btnRefresh: document.getElementById('btnRefresh'),
      btnExportCSV: document.getElementById('btnExportCSV'),
      btnExportJSON: document.getElementById('btnExportJSON'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      
      // Loading
      loadingText: document.getElementById('loadingText'),
      loadingSubtext: document.getElementById('loadingSubtext')
    };

    // ==================== UTILITY FUNCTIONS ====================
    function formatNumber(num) {
      if (num === undefined || num === null) return '0';
      return new Intl.NumberFormat().format(num);
    }

    function showStatusMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warn' ? '#ffc107' : '#17a2b8';
      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `
        <span style="font-size:20px;">${icon}</span>
        <div>
          <div style="font-weight:600;">${message}</div>
          <div style="font-size:12px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div>
        </div>
      `;
      el.statusContainer.appendChild(msgDiv);
      
      setTimeout(() => {
        if (msgDiv.parentNode) {
          msgDiv.style.opacity = '0';
          msgDiv.style.transform = 'translateX(100%)';
          setTimeout(() => msgDiv.remove(), 300);
        }
      }, 5000);
    }

    function setLoading(show, text = '', subtext = '') {
      if (show) {
        el.loadingText.textContent = text;
        el.loadingSubtext.textContent = subtext;
        el.loadingOverlay.classList.add('active');
      } else {
        el.loadingOverlay.classList.remove('active');
      }
    }

    function getPeriodDisplayName(periodIndex) {
      const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
      
      const today = new Date();
      let targetMonth = today.getMonth() - periodIndex;
      let targetYear = today.getFullYear();
      
      if (targetMonth < 0) {
        targetMonth += 12;
        targetYear -= 1;
      }
      
      if (periodIndex === 0) return `Current Month (${monthNames[targetMonth]} ${targetYear})`;
      if (periodIndex === 1) return `Last Month (${monthNames[targetMonth]} ${targetYear})`;
      return `Previous Month (${monthNames[targetMonth]} ${targetYear})`;
    }

    function getUtilizationClass(utilization) {
      if (utilization >= 90) return 'danger-row';
      if (utilization >= 75) return 'highlight-row';
      if (utilization <= 25) return 'highlight-row';
      return 'success-row';
    }

    function getUtilizationIndicator(utilization) {
      if (utilization >= 75) {
        return '<span class="utilization-indicator utilization-high"></span><span class="utilization-high-text">High</span>';
      }
      if (utilization >= 50) {
        return '<span class="utilization-indicator utilization-medium"></span><span class="utilization-medium-text">Medium</span>';
      }
      return '<span class="utilization-indicator utilization-low"></span><span class="utilization-low-text">Low</span>';
    }

    function getUtilizationTextColor(utilization) {
      if (utilization >= 75) return 'utilization-high-text';
      if (utilization >= 50) return 'utilization-medium-text';
      return 'utilization-low-text';
    }

    // ==================== AUTHENTICATION FUNCTIONS ====================
    function parseTokenFromHash() {
      const hash = window.location.hash.replace(/^#/, '');
      if (!hash) return {};
      
      const params = new URLSearchParams(hash);
      return {
        token: params.get('access_token'),
        refreshToken: params.get('refresh_token'),
        error: params.get('error'),
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in')
      };
    }

    function saveCredentials(token, expiresIn, refreshToken = null) {
      try {
        const tokenExpiry = Date.now() + (parseInt(expiresIn, 10) * 1000);
        localStorage.setItem(CONFIG.STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(CONFIG.STORAGE_KEYS.TOKEN_EXPIRY, tokenExpiry.toString());
        if (refreshToken) localStorage.setItem(CONFIG.STORAGE_KEYS.REFRESH_TOKEN, refreshToken);
        return true;
      } catch (e) {
        console.error('Failed to save credentials:', e);
        return false;
      }
    }

    function loadStoredCredentials() {
      try {
        const token = localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN);
        const tokenExpiry = localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN_EXPIRY);

        if (token && tokenExpiry) {
          if (Date.now() < parseInt(tokenExpiry, 10) - (5 * 60 * 1000)) {
            return { token };
          }
        }
      } catch (e) {
        console.warn('Failed to load stored credentials:', e);
      }
      return null;
    }

    function clearCredentials() {
      try {
        localStorage.removeItem(CONFIG.STORAGE_KEYS.TOKEN);
        localStorage.removeItem(CONFIG.STORAGE_KEYS.TOKEN_EXPIRY);
        localStorage.removeItem(CONFIG.STORAGE_KEYS.REFRESH_TOKEN);
      } catch (e) {
        console.error('Failed to clear credentials:', e);
      }
    }

    async function attemptTokenRefresh() {
      const refreshToken = localStorage.getItem(CONFIG.STORAGE_KEYS.REFRESH_TOKEN);
      if (!refreshToken) return false;
      
      try {
        const loginUrl = CONFIG.ENVIRONMENTS[CONFIG.ENVIRONMENT_REGION]?.login;
        const response = await fetch(`${loginUrl}/oauth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(`${CONFIG.CLIENT_ID}:`)
          },
          body: new URLSearchParams({
            grant_type: 'refresh_token',
            refresh_token: refreshToken
          })
        });

        if (response.ok) {
          const data = await response.json();
          saveCredentials(data.access_token, data.expires_in, data.refresh_token || refreshToken);
          return true;
        }
      } catch (error) {
        console.warn('Token refresh failed:', error);
      }
      return false;
    }

    function authUrl() {
      const env = CONFIG.ENVIRONMENTS[CONFIG.ENVIRONMENT_REGION];
      const state = btoa(JSON.stringify({ 
        env: CONFIG.ENVIRONMENT_REGION,
        ts: Date.now()
      }));
      
      return `${env.login}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.CLIENT_ID)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&state=${encodeURIComponent(state)}`;
    }

    async function initAuth() {
      el.authContainer.style.display = 'flex';
      
      const { token, refreshToken, error, errorDescription, expiresIn } = parseTokenFromHash();
      
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      }

      if (token) {
        if (saveCredentials(token, expiresIn || '3600', refreshToken)) {
          appState.isAuthenticated = true;
          el.authContainer.style.display = 'none';
          el.mainContent.style.display = 'block';
          initializeApp();
          return;
        }
      }

      if (error) {
        showStatusMessage(`Authentication failed: ${error}`, 'error');
        setTimeout(() => authenticate(), 2000);
        return;
      }

      const credentials = loadStoredCredentials();
      if (credentials) {
        appState.isAuthenticated = true;
        el.authContainer.style.display = 'none';
        el.mainContent.style.display = 'block';
        initializeApp();
        return;
      }

      const refreshSuccess = await attemptTokenRefresh();
      if (refreshSuccess) {
        appState.isAuthenticated = true;
        el.authContainer.style.display = 'none';
        el.mainContent.style.display = 'block';
        initializeApp();
        return;
      }

      setTimeout(() => authenticate(), 1000);
    }

    function authenticate() {
      const authUrlValue = authUrl();
      if (authUrlValue) {
        window.location.href = authUrlValue;
      } else {
        showStatusMessage('Could not generate authentication URL', 'error');
      }
    }

    function disconnect() {
      if (confirm('Disconnect from Genesys Cloud? This will clear all stored credentials.')) {
        clearCredentials();
        appState.isAuthenticated = false;
        appState.usageData = null;
        appState.rawApiData = null;
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'flex';
        showStatusMessage('Disconnected from Genesys Cloud', 'info');
      }
    }

    // ==================== API FUNCTIONS ====================
    async function apiCall(path, options = {}) {
      const token = localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN);
      if (!token) {
        showStatusMessage('Authentication required', 'error');
        disconnect();
        return null;
      }
      
      const env = CONFIG.ENVIRONMENTS[CONFIG.ENVIRONMENT_REGION];
      const url = `${env.api}${path}`;
      
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });

        if (response.status === 401 || response.status === 403) {
          const refreshSuccess = await attemptTokenRefresh();
          if (!refreshSuccess) {
            showStatusMessage('Session expired. Please reauthenticate.', 'error');
            disconnect();
            return null;
          }
          return apiCall(path, options);
        }
        
        if (response.status === 429) {
          const retryAfter = response.headers.get('Retry-After') || 5;
          showStatusMessage(`Rate limit exceeded. Retrying in ${retryAfter} seconds...`, 'warn');
          await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
          return apiCall(path, options);
        }
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          throw new Error(`API Error: ${response.status} ${response.statusText}`);
        }
        
        return response.json();
      } catch (error) {
        console.error('API call failed:', error);
        showStatusMessage(`API Error: ${error.message}`, 'error');
        return null;
      }
    }

    async function fetchBillingData(periodIndex) {
      setLoading(true, 'Fetching Billing Data', `Loading ${getPeriodDisplayName(periodIndex)} from Genesys Cloud...`);
      
      try {
        // Call the trusted organization billing API
        const endpoint = `/api/v2/billing/trusteebillingoverview/${CONFIG.TRUSTED_ORG_ID}`;
        
        const rawApiResponse = await apiCall(endpoint);
        
        if (!rawApiResponse) {
          throw new Error('No data returned from API');
        }
        
        console.log('API Response:', rawApiResponse);
        
        // Store raw API data
        appState.rawApiData = rawApiResponse;
        appState.lastFetchTime = new Date();
        
        // Parse the API response into our format
        const parsedData = parseApiData(rawApiResponse, periodIndex);
        appState.usageData = parsedData;
        
        // Store in history
        appState.billingHistory[periodIndex] = {
          period: periodIndex,
          periodName: getPeriodDisplayName(periodIndex),
          data: parsedData,
          rawData: rawApiResponse,
          timestamp: new Date()
        };
        
        updateDisplay();
        setLoading(false);
        
        showStatusMessage(`‚úÖ ${getPeriodDisplayName(periodIndex)} data loaded`, 'success');
        
      } catch (error) {
        setLoading(false);
        showStatusMessage(`Failed to fetch billing data: ${error.message}`, 'error');
        console.error('Error fetching billing data:', error);
        
        // Fallback to sample data if API fails (for testing)
        useSampleData(periodIndex);
      }
    }

    function parseApiData(apiData, periodIndex) {
      if (!apiData || !apiData.billingOverview) {
        throw new Error('Invalid API response structure');
      }
      
      const products = apiData.billingOverview.products || [];
      
      // Parse user licenses
      const users = parseUserLicenses(products);
      
      // Parse resources
      const resources = parseResources(products);
      
      return {
        period: periodIndex,
        periodName: getPeriodDisplayName(periodIndex),
        users: users,
        resources: resources,
        rawProducts: products
      };
    }

    function parseUserLicenses(products) {
      const userLicenses = [];
      
      // Filter for user license products
      const userProducts = products.filter(product => 
        product.name && (
          product.name.includes('Genesys Cloud CX 2') ||
          product.name.includes('WEM Add-On') ||
          product.name.includes('Communicate User') ||
          product.name.includes('Wallboard Device Charge')
        )
      );
      
      userProducts.forEach(product => {
        const usageQuantity = parseFloat(product.usageQuantity) || 0;
        const prepayQuantity = parseFloat(product.prepayQuantity) || 0;
        const overageQuantity = Math.max(0, usageQuantity - prepayQuantity);
        
        // Extract used from name if available (e.g., "Committed(256 used)")
        let used = 0;
        const name = product.name || '';
        const usedMatch = name.match(/\((\d+)\s*used\)/);
        if (usedMatch) {
          used = parseInt(usedMatch[1]);
        }
        
        // Determine committed and on-demand
        const committed = prepayQuantity;
        const onDemand = overageQuantity;
        
        userLicenses.push({
          name: product.name,
          qty: usageQuantity,
          committed: committed,
          used: used,
          onDemand: onDemand,
          items: [
            { 
              name: `Committed${used > 0 ? `(${used} used)` : ''}`, 
              qty: committed, 
              used: used 
            },
            { name: "On-Demand", qty: onDemand, used: onDemand }
          ]
        });
      });
      
      return userLicenses;
    }

    function parseResources(products) {
      const resources = [];
      const byocItems = [];
      const otherItems = [];
      
      // Filter for resource products
      const resourceProducts = products.filter(product => 
        product.name && (
          product.name.includes('BYOT') ||
          product.name.includes('BYOC Cloud') ||
          product.name.includes('SMS') ||
          product.name.includes('Predictive Engagement') ||
          product.name.includes('Voice Transcription') ||
          product.name.includes('WhatsApp') ||
          product.name.includes('Outbound Email') ||
          product.name.includes('IVR Basic') ||
          product.name.includes('API Resource')
        )
      );
      
      resourceProducts.forEach(product => {
        const usageQuantity = parseFloat(product.usageQuantity) || 0;
        const prepayQuantity = parseFloat(product.prepayQuantity) || 0;
        const overageQuantity = Math.max(0, usageQuantity - prepayQuantity);
        
        // Determine unit from product name or type
        let unit = 'units';
        if (product.name.includes('Per Minute') || product.name.includes('Transcription') || product.name.includes('IVR')) {
          unit = 'minutes';
        } else if (product.name.includes('Per Transaction') || product.name.includes('Events')) {
          unit = 'transactions';
        } else if (product.name.includes('API Resource')) {
          unit = 'requests';
        }
        
        const resource = {
          name: product.name,
          qty: usageQuantity,
          unit: unit,
          included: { 
            qty: prepayQuantity, 
            used: Math.min(usageQuantity, prepayQuantity) 
          },
          onDemand: overageQuantity
        };
        
        // Categorize resources
        if (product.name.includes('BYOT')) {
          byocItems.push(resource);
        } else {
          otherItems.push(resource);
        }
      });
      
      // Add BYOC Cloud category if there are BYOT items
      if (byocItems.length > 0) {
        resources.push({
          category: "BYOC Cloud",
          items: byocItems
        });
      }
      
      // Add other resources
      if (otherItems.length > 0) {
        resources.push({
          category: "Other Resources",
          items: otherItems
        });
      }
      
      return resources;
    }

    function useSampleData(periodIndex) {
      // Fallback sample data structure
      const SAMPLE_DATA = {
        0: {
          users: [
            {
              name: "Genesys Cloud CX 2",
              qty: 330,
              committed: 330,
              used: 256,
              onDemand: 0,
              items: [
                { name: "Committed(256 used)", qty: 330, used: 256 },
                { name: "On-Demand", qty: 0, used: 0 }
              ]
            },
            {
              name: "Genesys Cloud CX 2 WEM Add-On I",
              qty: 93,
              committed: 70,
              used: 70,
              onDemand: 23,
              items: [
                { name: "Committed", qty: 70, used: 70 },
                { name: "On-Demand", qty: 23, used: 23 }
              ]
            },
            {
              name: "Genesys Cloud Communicate User",
              qty: 80,
              committed: 80,
              used: 29,
              onDemand: 0,
              items: [
                { name: "Committed(29 used)", qty: 80, used: 29 },
                { name: "On-Demand", qty: 0, used: 0 }
              ]
            },
            {
              name: "Genesys Cloud for Wallboard Device Charge (view notes)",
              qty: 4,
              committed: 4,
              used: 1,
              onDemand: 0,
              items: [
                { name: "Committed(1 used)", qty: 4, used: 1 },
                { name: "On-Demand", qty: 0, used: 0 }
              ]
            }
          ],
          resources: [
            {
              category: "BYOC Cloud",
              items: [
                { 
                  name: "BYOT Rate A", 
                  qty: 0, 
                  unit: "units", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 0
                },
                { 
                  name: "BYOT Rate B Per Transaction", 
                  qty: 0, 
                  unit: "units", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 0
                },
                { 
                  name: "BYOT Rate C Per Minute", 
                  qty: 0, 
                  unit: "minutes", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 0
                },
                { 
                  name: "BYOT Rate D Per Transaction", 
                  qty: 0, 
                  unit: "units", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 0
                },
                { 
                  name: "BYOT Rate E Per Minute", 
                  qty: 0, 
                  unit: "minutes", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 0
                }
              ]
            },
            {
              category: "Other Resources",
              items: [
                { 
                  name: "Genesys Cloud BYOC Cloud", 
                  qty: 1, 
                  unit: "units", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 1
                },
                { 
                  name: "Genesys Cloud Short Message Service (SMS)", 
                  qty: 0, 
                  unit: "units", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 0
                },
                { 
                  name: "Genesys Cloud for Predictive Engagement Events", 
                  qty: 0, 
                  unit: "events", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 0
                },
                { 
                  name: "Genesys Cloud for Voice Transcription Fair Use (Legacy)", 
                  qty: 484200, 
                  unit: "minutes", 
                  included: { qty: 484200, used: 17668 }, 
                  onDemand: 0
                },
                { 
                  name: "Genesys Cloud for WhatsApp Messaging", 
                  qty: 0, 
                  unit: "units", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 0
                },
                { 
                  name: "Outbound Email Monthly", 
                  qty: 0, 
                  unit: "transactions", 
                  included: { qty: 0, used: 0 }, 
                  onDemand: 0
                },
                { 
                  name: "Genesys Cloud IVR Basic Per Minute Charge", 
                  qty: 865000, 
                  unit: "minutes", 
                  included: { qty: 865000, used: 5330 }, 
                  onDemand: 0
                },
                { 
                  name: "Genesys Cloud API Resource", 
                  qty: 37100000, 
                  unit: "requests", 
                  included: { qty: 37100000, used: 451095 }, 
                  onDemand: 0
                }
              ]
            }
          ]
        }
      };
      
      // Use sample data for the requested period (fallback to current month if not available)
      const samplePeriod = SAMPLE_DATA[periodIndex] || SAMPLE_DATA[0];
      
      appState.usageData = {
        period: periodIndex,
        periodName: getPeriodDisplayName(periodIndex),
        users: samplePeriod.users,
        resources: samplePeriod.resources
      };
      
      appState.lastFetchTime = new Date();
      updateDisplay();
      setLoading(false);
      
      showStatusMessage('‚ö†Ô∏è Using sample data (API unavailable)', 'warn');
    }

    // ==================== DISPLAY FUNCTIONS ====================
    function updateDisplay() {
      if (!appState.usageData) return;
      
      const data = appState.usageData;
      
      // Update last updated time
      el.lastUpdated.textContent = `Last updated: ${appState.lastFetchTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
      
      // Update period selector
      document.querySelectorAll('.period-option').forEach(option => {
        if (parseInt(option.dataset.period) === appState.currentPeriod) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
      
      // Update metric tiles
      updateMetricTiles(data);
      
      // Update tables
      updateUsersTable(data.users);
      updateResourcesTable(data.resources);
      updateHighlightsTable(data);
    }

    function updateMetricTiles(data) {
      // Calculate user metrics
      let totalUsers = 0;
      let totalCommitted = 0;
      let totalUsed = 0;
      let totalOnDemand = 0;
      let overageRisk = 0;
      
      data.users.forEach(user => {
        totalUsers += user.qty;
        totalCommitted += user.committed;
        totalUsed += user.used;
        totalOnDemand += user.onDemand;
        
        // Check for overage risk (On-Demand usage)
        if (user.onDemand > 0) {
          overageRisk += user.onDemand;
        }
      });
      
      const utilizationPct = totalCommitted > 0 ? Math.round((totalUsed / totalCommitted) * 100) : 0;
      
      // Update total users tile
      el.totalUsersValue.textContent = formatNumber(totalUsers);
      el.usersUtilization.innerHTML = `
        <strong>Utilization:</strong> ${utilizationPct}%<br>
        <strong>Committed:</strong> ${formatNumber(totalCommitted)} | <strong>Used:</strong> ${formatNumber(totalUsed)} | <strong>On-Demand:</strong> ${formatNumber(totalOnDemand)}
      `;
      
      // Update overage risk tile
      el.overageRiskValue.textContent = overageRisk > 0 ? `${formatNumber(overageRisk)}` : 'None';
      const overageTile = el.metricUserOverage;
      if (overageRisk > 0) {
        overageTile.className = 'metric-card danger';
        overageTile.querySelector('.metric-icon').textContent = 'üö®';
        el.overageDetail.textContent = `${formatNumber(overageRisk)} user licenses on-demand (potential overage)`;
      } else {
        overageTile.className = 'metric-card success';
        overageTile.querySelector('.metric-icon').textContent = '‚úÖ';
        el.overageDetail.textContent = 'All licenses are committed (no overage risk)';
      }
      
      // Calculate speech analytics metrics
      let speechPrepaid = 0;
      let speechUsed = 0;
      let ivrPrepaid = 0;
      let ivrUsed = 0;
      
      data.resources.forEach(category => {
        category.items.forEach(resource => {
          if (resource.name.includes('Voice Transcription')) {
            speechPrepaid = resource.included.qty;
            speechUsed = resource.included.used;
          }
          if (resource.name.includes('IVR Basic')) {
            ivrPrepaid = resource.included.qty;
            ivrUsed = resource.included.used;
          }
        });
      });
      
      const speechUtilization = speechPrepaid > 0 ? Math.round((speechUsed / speechPrepaid) * 100) : 0;
      const ivrUtilization = ivrPrepaid > 0 ? Math.round((ivrUsed / ivrPrepaid) * 100) : 0;
      
      // Update speech analytics tile
      el.speechUsageValue.textContent = `${speechUtilization}%`;
      el.speechUsed.textContent = formatNumber(speechUsed);
      el.speechPrepaid.textContent = formatNumber(speechPrepaid);
      el.speechProgressUsed.style.width = `${speechUtilization}%`;
      el.speechDetail.textContent = `${formatNumber(speechUsed)} of ${formatNumber(speechPrepaid)} minutes used`;
      
      // Update IVR tile
      el.ivrUsageValue.textContent = `${ivrUtilization}%`;
      el.ivrDetail.textContent = `${formatNumber(ivrUsed)} of ${formatNumber(ivrPrepaid)} minutes used`;
    }

    function updateUsersTable(users) {
      const tbody = el.usersTableBody;
      tbody.innerHTML = '';
      
      if (!users || users.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="7" style="text-align:center;padding:48px;color:var(--text-light);">
            No user license data available
          </td></tr>
        `;
        return;
      }
      
      users.forEach(user => {
        const utilization = user.committed > 0 ? Math.round((user.used / user.committed) * 100) : 0;
        const rowClass = getUtilizationClass(utilization);
        const utilizationColorClass = getUtilizationTextColor(utilization);
        
        const row = document.createElement('tr');
        row.className = rowClass;
        row.innerHTML = `
          <td class="text-left"><strong>${user.name}</strong></td>
          <td class="number-cell">${formatNumber(user.qty)}</td>
          <td class="number-cell">${formatNumber(user.committed)}</td>
          <td class="number-cell">${formatNumber(user.used)}</td>
          <td class="number-cell">${formatNumber(user.onDemand)}</td>
          <td class="number-cell ${utilizationColorClass}">${utilization}%</td>
          <td>${getUtilizationIndicator(utilization)}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateResourcesTable(resources) {
      const tbody = el.resourcesTableBody;
      tbody.innerHTML = '';
      
      if (!resources || resources.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="7" style="text-align:center;padding:48px;color:var(--text-light);">
            No resource data available
          </td></tr>
        `;
        return;
      }
      
      resources.forEach(category => {
        // Category header
        if (category.category) {
          const headerRow = document.createElement('tr');
          headerRow.className = 'category-header';
          headerRow.innerHTML = `
            <td colspan="7" style="font-weight:700;font-size:14px;" class="text-left">${category.category}</td>
          `;
          tbody.appendChild(headerRow);
        }
        
        // Resource items
        category.items.forEach(resource => {
          const includedQty = resource.included.qty;
          const usedQty = resource.included.used;
          const utilization = includedQty > 0 ? Math.round((usedQty / includedQty) * 100) : 0;
          const utilizationColorClass = getUtilizationTextColor(utilization);
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="text-left">${resource.name}</td>
            <td class="number-cell">${formatNumber(resource.qty)}</td>
            <td>${resource.unit}</td>
            <td class="number-cell">${formatNumber(includedQty)}</td>
            <td class="number-cell">${formatNumber(usedQty)}</td>
            <td class="number-cell">${formatNumber(resource.onDemand)}</td>
            <td class="number-cell ${utilizationColorClass}">${includedQty > 0 ? `${utilization}%` : 'N/A'}</td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function updateHighlightsTable(data) {
      // Update user highlights
      const userTbody = el.highlightsUsersTable;
      userTbody.innerHTML = '';
      
      if (!data.users || data.users.length === 0) {
        userTbody.innerHTML = `
          <tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-light);">
            No user license data available
          </td></tr>
        `;
        return;
      }
      
      data.users.forEach(user => {
        const utilization = user.committed > 0 ? Math.round((user.used / user.committed) * 100) : 0;
        const utilizationColorClass = getUtilizationTextColor(utilization);
        let status = '';
        
        if (utilization <= 25) {
          status = '<span style="color:var(--danger);">‚ö†Ô∏è Underutilized</span>';
        } else if (user.onDemand > 0) {
          status = '<span style="color:var(--warning);">‚ö†Ô∏è Using On-Demand</span>';
        } else if (utilization >= 90) {
          status = '<span style="color:var(--danger);">üö® Near Capacity</span>';
        } else {
          status = '<span style="color:var(--success);">‚úÖ Optimal</span>';
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="text-left"><strong>${user.name}</strong></td>
          <td class="number-cell">${formatNumber(user.qty)}</td>
          <td class="number-cell">${formatNumber(user.committed)}</td>
          <td class="number-cell">${formatNumber(user.used)}</td>
          <td class="number-cell">${formatNumber(user.onDemand)}</td>
          <td class="number-cell ${utilizationColorClass}">${utilization}%</td>
          <td>${status}</td>
        `;
        userTbody.appendChild(row);
      });
      
      // Update speech analytics highlights
      let speechResource = null;
      data.resources.forEach(category => {
        category.items.forEach(resource => {
          if (resource.name.includes('Voice Transcription')) {
            speechResource = resource;
          }
        });
      });
      
      if (speechResource) {
        const speechPrepaid = speechResource.included.qty;
        const speechUsed = speechResource.included.used;
        const speechRemaining = speechPrepaid - speechUsed;
        const speechUtilization = Math.round((speechUsed / speechPrepaid) * 100);
        
        el.highlightSpeechUsed.textContent = formatNumber(speechUsed);
        el.highlightSpeechPrepaid.textContent = formatNumber(speechPrepaid);
        el.highlightSpeechRemaining.textContent = formatNumber(speechRemaining);
        el.highlightSpeechUsedBar.style.width = `${speechUtilization}%`;
        el.highlightSpeechRemainingBar.style.width = `${100 - speechUtilization}%`;
        el.highlightSpeechUsedPct.textContent = `${speechUtilization}%`;
        el.highlightSpeechAvailablePct.textContent = `${100 - speechUtilization}%`;
        
        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        el.highlightSpeechDaysLeft.textContent = daysInMonth - today.getDate();
      }
      
      // Update resource highlights
      const resourceTbody = el.highlightsResourcesTable;
      resourceTbody.innerHTML = '';
      
      if (!data.resources || data.resources.length === 0) {
        resourceTbody.innerHTML = `
          <tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-light);">
            No resource data available
          </td></tr>
        `;
        return;
      }
      
      const highlightResources = [];
      data.resources.forEach(category => {
        category.items.forEach(resource => {
          if (resource.qty > 0 && (resource.name.includes('Voice Transcription') || 
                                   resource.name.includes('IVR') || 
                                   resource.name.includes('API Resource'))) {
            highlightResources.push(resource);
          }
        });
      });
      
      if (highlightResources.length === 0) {
        resourceTbody.innerHTML = `
          <tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-light);">
            No highlight resources found
          </td></tr>
        `;
        return;
      }
      
      highlightResources.forEach(resource => {
        const total = resource.qty;
        const used = resource.included.used;
        const available = resource.included.qty - resource.included.used;
        const utilization = resource.included.qty > 0 
          ? Math.round((used / resource.included.qty) * 100)
          : 0;
        const utilizationColorClass = getUtilizationTextColor(utilization);
        
        let status = '';
        if (resource.name.includes('Voice Transcription')) {
          if (utilization > 50) {
            status = '<span style="color:var(--warning);">‚ö†Ô∏è High Usage</span>';
          } else {
            status = '<span style="color:var(--success);">‚úÖ Normal</span>';
          }
        } else if (resource.name.includes('IVR')) {
          if (utilization > 10) {
            status = '<span style="color:var(--warning);">‚ö†Ô∏è Monitor</span>';
          } else {
            status = '<span style="color:var(--success);">‚úÖ Low</span>';
          }
        } else {
          status = '<span style="color:var(--info);">üìä Active</span>';
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="text-left">${resource.name}</td>
          <td class="number-cell">${formatNumber(total)} ${resource.unit}</td>
          <td class="number-cell">${formatNumber(used)} ${resource.unit}</td>
          <td class="number-cell">${formatNumber(available)} ${resource.unit}</td>
          <td class="number-cell">${formatNumber(resource.onDemand)} ${resource.unit}</td>
          <td class="number-cell ${utilizationColorClass}">${utilization}%</td>
          <td>${status}</td>
        `;
        resourceTbody.appendChild(row);
      });
    }

    // ==================== EXPORT FUNCTIONS ====================
    function exportToCSV() {
      if (!appState.usageData) {
        showStatusMessage('No data to export', 'warn');
        return;
      }
      
      let csv = `Genesys Cloud Usage Dashboard - ${getPeriodDisplayName(appState.currentPeriod)}\n`;
      csv += `Generated,${new Date().toLocaleString()}\n\n`;
      
      // Users section
      csv += 'USER LICENSES\n';
      csv += 'Service,Total Qty,Committed,Used,On-Demand,Utilization%\n';
      
      appState.usageData.users.forEach(user => {
        const utilization = user.committed > 0 ? Math.round((user.used / user.committed) * 100) : 0;
        csv += `"${user.name}",${user.qty},${user.committed},${user.used},${user.onDemand},${utilization}%\n`;
      });
      
      csv += '\nRESOURCES (excludes Cloud Voice charges)\n';
      csv += 'Resource,Total Qty,Unit,Included Qty,Used,On-Demand,Utilization%\n';
      
      appState.usageData.resources.forEach(category => {
        category.items.forEach(resource => {
          const utilization = resource.included.qty > 0 
            ? Math.round((resource.included.used / resource.included.qty) * 100)
            : 0;
          csv += `"${resource.name}",${resource.qty},${resource.unit},${resource.included.qty},${resource.included.used},${resource.onDemand},${utilization}%\n`;
        });
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_usage_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showStatusMessage('‚úÖ CSV exported successfully', 'success');
    }

    function exportToJSON() {
      if (!appState.usageData || !appState.rawApiData) {
        showStatusMessage('No data to export', 'warn');
        return;
      }
      
      const exportData = {
        period: getPeriodDisplayName(appState.currentPeriod),
        periodIndex: appState.currentPeriod,
        generated: new Date().toISOString(),
        parsedData: appState.usageData,
        rawApiData: appState.rawApiData
      };
      
      const json = JSON.stringify(exportData, null, 2);
      const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_usage_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showStatusMessage('‚úÖ JSON exported successfully', 'success');
    }

    // ==================== EVENT HANDLERS ====================
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          appState.currentTab = tabId;
          
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) content.classList.add('active');
          });
        });
      });
      
      // Period selection
      document.querySelectorAll('.period-option').forEach(option => {
        option.addEventListener('click', function() {
          const periodIndex = parseInt(this.dataset.period);
          appState.currentPeriod = periodIndex;
          fetchBillingData(periodIndex);
        });
      });
      
      // Action buttons
      el.btnRefresh.addEventListener('click', function() {
        fetchBillingData(appState.currentPeriod);
      });
      
      el.btnExportCSV.addEventListener('click', exportToCSV);
      el.btnExportJSON.addEventListener('click', exportToJSON);
      el.btnDisconnect.addEventListener('click', disconnect);
    }

    // ==================== INITIALIZATION ====================
    function initializeApp() {
      setupEventListeners();
      
      // Update organization name
      el.orgNameDisplay.textContent = `${CONFIG.CUSTOMER_NAME} Trusted Organization`;
      
      // Fetch initial data for current period
      fetchBillingData(0);
    }

    // ==================== START APPLICATION ====================
    document.addEventListener('DOMContentLoaded', initAuth);
  </script>
</body>
</html>
