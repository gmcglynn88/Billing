<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud - Usage Dashboard</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      --success:#28a745; --info:#17a2b8; --chart-blue:#4e73df; --chart-green:#1cc88a;
      --chart-yellow:#f6c23e; --chart-red:#e74a3b; --chart-purple:#6f42c1;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:0; padding:0;
      background:var(--light-bg);color:var(--text-color);
      line-height:1.6;
    }

    .container{
      max-width:none;
      margin:0 20px;
      width:calc(100% - 40px);
    }
    
    header{
      background:var(--card-bg);border-radius:12px;padding:28px 36px;
      margin-bottom:28px;box-shadow:0 2px 8px rgba(0,0,0,.08);
      border-left:5px solid var(--primary-color);border:1px solid var(--border-color);
      margin-top:20px;
    }

    h1{color:var(--text-color);margin-bottom:12px;font-size:32px;font-weight:600;}
    .subtitle{color:var(--text-light);font-size:17px;}
    
    @media(max-width:1200px){
      .container{margin:0 15px;width:calc(100% - 30px);}
    }

    .card{
      background:var(--card-bg);border:1px solid var(--border-color);
      border-radius:14px;padding:28px;margin-bottom:20px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }

    .card h2{
      color:var(--primary-color);margin-bottom:24px;font-size:22px;
      padding-bottom:16px;border-bottom:2px solid var(--light-bg);
      display:flex;align-items:center;gap:12px;
      font-weight:600;
    }

    .form-group{margin-bottom:24px}
    label{display:block;font-weight:600;margin-bottom:8px;color:var(--text-color);font-size:14px;}
    select,input,button{
      padding:12px;border:1px solid var(--border-color);
      border-radius:8px;background:var(--card-bg);font-size:15px;width:100%;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s;border:none;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      font-size:15px;
    }

    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .btn-block{width:100%;padding:14px}
    
    .status-container{
      position:fixed;top:20px;right:20px;z-index:1000;
      display:flex;flex-direction:column;gap:10px;
      max-width:400px;
    }

    .status-message{
      background:white;padding:16px;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:4px solid var(--primary-color);
      animation:slideIn 0.3s ease-out;display:flex;align-items:center;gap:12px;
    }

    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }

    .table-container{
      overflow-x:auto;margin-top:24px;border-radius:10px;
      border:1px solid var(--border-color);background:var(--card-bg);
      max-height:600px;overflow-y:auto;
    }

    table{width:100%;border-collapse:collapse}
    th{
      background-color:var(--primary-color);color:white;font-weight:600;
      position:sticky;top:0;z-index:10;white-space:nowrap;padding:18px;text-align:left;
      font-size:14px;
    }
    td{padding:16px 18px;border-bottom:1px solid var(--border-color);font-size:14px;}
    tr:hover{background-color:var(--pill)}

    .tabs{
      display:flex;border-bottom:2px solid var(--border-color);
      margin-bottom:28px;background:white;border-radius:10px 10px 0 0;
    }

    .tab{
      padding:18px 28px;background:none;border:none;
      border-bottom:2px solid transparent;font-size:16px;
      font-weight:600;color:var(--text-light);cursor:pointer;
      transition:all 0.3s;flex:1;text-align:center;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    .tab:hover{color:var(--primary-color)}
    .tab.active{
      color:var(--primary-color);border-bottom-color:var(--primary-color);
      background:rgba(99,171,143,0.05);
    }

    .tab-content{display:none;animation:fadeIn 0.3s ease}
    .tab-content.active{display:block}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .loading-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);display:flex;
      flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;display:none;
    }

    .loading-overlay.active{display:flex}
    .spinner{
      width:60px;height:60px;border:5px solid #f3f3f3;
      border-top:5px solid var(--primary-color);border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:20px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:768px){
      body{margin:10px;padding:0}
      .card{padding:20px}
      header{padding:20px;margin-top:10px;}
      h1{font-size:28px}
      .btn-block{padding:12px 18px;font-size:15px}
      .container{margin:0 10px;width:calc(100% - 20px);}
    }

    /* Data summary styles */
    .data-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .summary-card {
      background: linear-gradient(135deg, rgba(99, 171, 143, 0.1), rgba(99, 171, 143, 0.05));
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(99, 171, 143, 0.3);
    }
    
    .summary-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 8px 0;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }
    
    .summary-label {
      font-size: 14px;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .summary-subtext {
      font-size: 13px;
      color: var(--secondary-color);
      margin-top: 8px;
    }
    
    /* Improved period selector */
    .period-selector {
      display: flex;
      gap: 12px;
      align-items: center;
      background: var(--pill);
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .period-option {
      flex: 1;
      text-align: center;
      padding: 12px;
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-color);
      transition: all 0.3s;
    }
    
    .period-option:hover {
      border-color: var(--primary-color);
      background: rgba(99, 171, 143, 0.05);
    }
    
    .period-option.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    /* Category headers in tables */
    .category-header {
      background-color: var(--light-bg) !important;
      font-weight: 700;
      font-size: 16px;
      color: var(--text-color);
      border-top: 2px solid var(--border-color);
      border-bottom: 2px solid var(--border-color);
    }
    
    .category-header td {
      padding: 20px 18px;
    }
    
    .sub-item {
      padding-left: 40px !important;
      font-size: 13px;
      color: var(--text-light);
    }
    
    .sub-item td:first-child:before {
      content: "‚Ü≥ ";
      margin-right: 8px;
    }
    
    /* Indentation for nested items */
    .indent-1 { padding-left: 40px !important; }
    .indent-2 { padding-left: 60px !important; }
    
    /* Total rows */
    .total-row {
      background-color: var(--pill) !important;
      font-weight: 700;
      border-top: 2px solid var(--border-color);
    }
    
    /* Number formatting */
    .number-cell {
      text-align: right;
      font-family: 'Aptos', monospace;
    }
    
    /* Status indicators */
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-active { background-color: var(--success); }
    .status-inactive { background-color: var(--text-light); }
    .status-warning { background-color: var(--warning); }
    
    /* Compact view for resources */
    .compact-table th,
    .compact-table td {
      padding: 12px 16px;
      font-size: 13px;
    }
    
    /* Section spacing */
    .section-spacing {
      margin-top: 40px;
    }
    
    .note {
      font-size: 12px;
      color: var(--text-light);
      font-style: italic;
      margin-top: 8px;
    }
    
    .cancel-btn {
      background: none;
      border: 1px solid var(--border-color);
      color: var(--text-light);
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .cancel-btn:hover {
      background: var(--light-bg);
      color: var(--danger);
      border-color: var(--danger);
    }
  </style>
</head>
<body>
  <div class="status-container" id="statusContainer"></div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:20px;font-weight:600;margin-bottom:12px;">Loading Usage Data...</div>
    <div id="loadingSubtext" style="font-size:15px;color:var(--text-light);text-align:center;max-width:500px;">Fetching Genesys Cloud usage information</div>
  </div>

  <div class="container">
    <header>
      <h1>üìä Genesys Cloud - Usage Dashboard</h1>
      <div class="subtitle" style="display:flex;justify-content:space-between;align-items:center;">
        <span id="orgNameDisplay">JLA Trusted Organization</span>
        <span id="lastUpdated" style="font-size:14px;background:var(--pill);padding:6px 12px;border-radius:20px;">Loading...</span>
      </div>
    </header>

    <!-- Period Selector -->
    <div class="period-selector">
      <div class="period-option active" data-period="0">Current Month</div>
      <div class="period-option" data-period="1">Last Month</div>
      <div class="period-option" data-period="2">Previous Month</div>
    </div>

    <!-- Data Summary -->
    <div class="data-summary" id="dataSummary">
      <div class="summary-card">
        <div class="summary-label">Total Users</div>
        <div class="summary-value" id="totalUsers">0</div>
        <div class="summary-subtext" id="usersDetail">Committed: 0 ‚Ä¢ On-Demand: 0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Total Resources</div>
        <div class="summary-value" id="totalResources">0</div>
        <div class="summary-subtext" id="resourcesDetail">Units: 0 ‚Ä¢ Minutes: 0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Bot Flow Units</div>
        <div class="summary-value" id="botFlowUnits">0</div>
        <div class="summary-subtext">Genesys Cloud for Bot Flow - Digital</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">API Requests</div>
        <div class="summary-value" id="apiRequests">0</div>
        <div class="summary-subtext">Genesys Cloud API Resource</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="users">üë• Users</button>
      <button class="tab" data-tab="resources">üì¶ Resources</button>
      <button class="tab" data-tab="all">üìã All Services</button>
    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="tab-content active">
      <div class="card">
        <h2>üë• User Licenses</h2>
        <div class="table-container">
          <table id="usersTable">
            <thead>
              <tr>
                <th>Service Name</th>
                <th>Qty</th>
                <th>Rate</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr><td colspan="5" style="text-align:center;padding:48px;color:var(--text-light);">
                Loading user data...
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Resources Tab -->
    <div id="tab-resources" class="tab-content">
      <div class="card">
        <h2>üì¶ Resources (excludes Cloud Voice charges)</h2>
        <div class="table-container">
          <table id="resourcesTable" class="compact-table">
            <thead>
              <tr>
                <th>Resource Name</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Included (Used)</th>
                <th>On-Demand</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="resourcesTableBody">
              <tr><td colspan="6" style="text-align:center;padding:48px;color:var(--text-light);">
                Loading resource data...
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- All Services Tab -->
    <div id="tab-all" class="tab-content">
      <div class="card">
        <h2>üìã All Services Overview</h2>
        <div class="table-container">
          <table id="allServicesTable">
            <thead>
              <tr>
                <th>Service Type</th>
                <th>Service Name</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Committed</th>
                <th>On-Demand</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="allServicesTableBody">
              <tr><td colspan="7" style="text-align:center;padding:48px;color:var(--text-light);">
                Loading all services data...
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Actions Card -->
    <div class="card" style="margin-top: 24px;">
      <h2>‚ö° Actions</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <button id="btnRefresh" class="btn btn-block">
          <span>üîÑ Refresh Data</span>
        </button>
        <button id="btnExportCSV" class="btn btn-block" style="background: var(--success);">
          <span>üìÑ Export CSV</span>
        </button>
        <button id="btnExportJSON" class="btn btn-block" style="background: var(--info);">
          <span>üîß Export JSON</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================== STATE MANAGEMENT ====================
    let appState = {
      currentTab: 'users',
      currentPeriod: 0, // 0 = Current Month, 1 = Last Month, 2 = Previous Month
      usageData: null,
      logs: [],
      lastFetchTime: null
    };

    // ==================== SAMPLE DATA ====================
    const SAMPLE_DATA = {
      0: { // Current Month
        users: [
          {
            name: "Genesys Cloud CX 2",
            qty: 330,
            rate: "users",
            total: "",
            items: [
              { name: "Committed(256 used)", qty: 330, rate: "", total: "" },
              { name: "On-Demand", qty: 0, rate: "", total: "" }
            ]
          },
          {
            name: "Genesys Cloud CX 2 WEM Add-On I",
            qty: 93,
            rate: "users",
            total: "",
            items: [
              { name: "Committed", qty: 70, rate: "", total: "" },
              { name: "On-Demand", qty: 23, rate: "", total: "" }
            ]
          },
          {
            name: "Genesys Cloud Communicate User",
            qty: 80,
            rate: "users",
            total: "",
            items: [
              { name: "Committed(29 used)", qty: 80, rate: "", total: "" },
              { name: "On-Demand", qty: 0, rate: "", total: "" }
            ]
          },
          {
            name: "Genesys Cloud for Wallboard Device Charge (view notes)",
            qty: 4,
            rate: "users",
            total: "",
            items: [
              { name: "Committed(1 used)", qty: 4, rate: "", total: "" },
              { name: "On-Demand", qty: 0, rate: "", total: "" }
            ]
          }
        ],
        resources: [
          {
            category: "BYOC Cloud",
            items: [
              { 
                name: "BYOT Rate A", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate B Per Transaction", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate C Per Minute", 
                qty: 0, 
                unit: "minutes", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate D Per Transaction", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate E Per Minute", 
                qty: 0, 
                unit: "minutes", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              }
            ]
          },
          {
            category: "Other Resources",
            items: [
              { 
                name: "Genesys Cloud BYOC Cloud", 
                qty: 1, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 1,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud Short Message Service (SMS)", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "Genesys Cloud for Bot Flow - Digital", 
                qty: 1417, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 1417,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud for Predictive Engagement Events", 
                qty: 0, 
                unit: "events", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "Genesys Cloud for Voice Transcription Fair Use (Legacy)", 
                qty: 484200, 
                unit: "minutes", 
                included: { qty: 17668, used: 17668 }, 
                onDemand: 0,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud for WhatsApp Messaging", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "Outbound Email Monthly", 
                qty: 0, 
                unit: "transactions", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "Genesys Cloud IVR Basic Per Minute Charge", 
                qty: 865000, 
                unit: "minutes", 
                included: { qty: 5330, used: 5330 }, 
                onDemand: 0,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud API Resource", 
                qty: 37100000, 
                unit: "requests", 
                included: { qty: 451095, used: 451095 }, 
                onDemand: 0,
                canCancel: false 
              }
            ]
          }
        ]
      },
      1: { // Last Month (modified sample)
        users: [
          {
            name: "Genesys Cloud CX 2",
            qty: 325,
            rate: "users",
            total: "",
            items: [
              { name: "Committed(240 used)", qty: 325, rate: "", total: "" },
              { name: "On-Demand", qty: 0, rate: "", total: "" }
            ]
          },
          {
            name: "Genesys Cloud CX 2 WEM Add-On I",
            qty: 90,
            rate: "users",
            total: "",
            items: [
              { name: "Committed", qty: 70, rate: "", total: "" },
              { name: "On-Demand", qty: 20, rate: "", total: "" }
            ]
          },
          {
            name: "Genesys Cloud Communicate User",
            qty: 75,
            rate: "users",
            total: "",
            items: [
              { name: "Committed(25 used)", qty: 75, rate: "", total: "" },
              { name: "On-Demand", qty: 0, rate: "", total: "" }
            ]
          },
          {
            name: "Genesys Cloud for Wallboard Device Charge (view notes)",
            qty: 4,
            rate: "users",
            total: "",
            items: [
              { name: "Committed(1 used)", qty: 4, rate: "", total: "" },
              { name: "On-Demand", qty: 0, rate: "", total: "" }
            ]
          }
        ],
        resources: [
          {
            category: "BYOC Cloud",
            items: [
              { 
                name: "BYOT Rate A", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate B Per Transaction", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate C Per Minute", 
                qty: 0, 
                unit: "minutes", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate D Per Transaction", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate E Per Minute", 
                qty: 0, 
                unit: "minutes", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              }
            ]
          },
          {
            category: "Other Resources",
            items: [
              { 
                name: "Genesys Cloud BYOC Cloud", 
                qty: 1, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 1,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud Short Message Service (SMS)", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "Genesys Cloud for Bot Flow - Digital", 
                qty: 1350, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 1350,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud for Voice Transcription Fair Use (Legacy)", 
                qty: 480000, 
                unit: "minutes", 
                included: { qty: 16500, used: 16500 }, 
                onDemand: 0,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud IVR Basic Per Minute Charge", 
                qty: 850000, 
                unit: "minutes", 
                included: { qty: 5200, used: 5200 }, 
                onDemand: 0,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud API Resource", 
                qty: 36500000, 
                unit: "requests", 
                included: { qty: 420000, used: 420000 }, 
                onDemand: 0,
                canCancel: false 
              }
            ]
          }
        ]
      },
      2: { // Previous Month (modified sample)
        users: [
          {
            name: "Genesys Cloud CX 2",
            qty: 320,
            rate: "users",
            total: "",
            items: [
              { name: "Committed(230 used)", qty: 320, rate: "", total: "" },
              { name: "On-Demand", qty: 0, rate: "", total: "" }
            ]
          },
          {
            name: "Genesys Cloud CX 2 WEM Add-On I",
            qty: 85,
            rate: "users",
            total: "",
            items: [
              { name: "Committed", qty: 70, rate: "", total: "" },
              { name: "On-Demand", qty: 15, rate: "", total: "" }
            ]
          },
          {
            name: "Genesys Cloud Communicate User",
            qty: 70,
            rate: "users",
            total: "",
            items: [
              { name: "Committed(20 used)", qty: 70, rate: "", total: "" },
              { name: "On-Demand", qty: 0, rate: "", total: "" }
            ]
          },
          {
            name: "Genesys Cloud for Wallboard Device Charge (view notes)",
            qty: 4,
            rate: "users",
            total: "",
            items: [
              { name: "Committed(1 used)", qty: 4, rate: "", total: "" },
              { name: "On-Demand", qty: 0, rate: "", total: "" }
            ]
          }
        ],
        resources: [
          {
            category: "BYOC Cloud",
            items: [
              { 
                name: "BYOT Rate A", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate B Per Transaction", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate C Per Minute", 
                qty: 0, 
                unit: "minutes", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate D Per Transaction", 
                qty: 0, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              },
              { 
                name: "BYOT Rate E Per Minute", 
                qty: 0, 
                unit: "minutes", 
                included: { qty: 0, used: 0 }, 
                onDemand: 0,
                canCancel: true 
              }
            ]
          },
          {
            category: "Other Resources",
            items: [
              { 
                name: "Genesys Cloud BYOC Cloud", 
                qty: 1, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 1,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud for Bot Flow - Digital", 
                qty: 1250, 
                unit: "units", 
                included: { qty: 0, used: 0 }, 
                onDemand: 1250,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud for Voice Transcription Fair Use (Legacy)", 
                qty: 475000, 
                unit: "minutes", 
                included: { qty: 15000, used: 15000 }, 
                onDemand: 0,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud IVR Basic Per Minute Charge", 
                qty: 840000, 
                unit: "minutes", 
                included: { qty: 5000, used: 5000 }, 
                onDemand: 0,
                canCancel: false 
              },
              { 
                name: "Genesys Cloud API Resource", 
                qty: 36000000, 
                unit: "requests", 
                included: { qty: 400000, used: 400000 }, 
                onDemand: 0,
                canCancel: false 
              }
            ]
          }
        ]
      }
    };

    // ==================== UTILITY FUNCTIONS ====================
    function formatNumber(num) {
      return new Intl.NumberFormat().format(num);
    }

    function showStatusMessage(message, type = 'info') {
      const statusContainer = document.getElementById('statusContainer');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warn' ? '#ffc107' : '#17a2b8';
      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `
        <span style="font-size:20px;">${icon}</span>
        <div>
          <div style="font-weight:600;">${message}</div>
          <div style="font-size:12px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div>
        </div>
      `;
      statusContainer.appendChild(msgDiv);
      
      setTimeout(() => {
        if (msgDiv.parentNode) {
          msgDiv.style.opacity = '0';
          msgDiv.style.transform = 'translateX(100%)';
          setTimeout(() => msgDiv.remove(), 300);
        }
      }, 5000);
    }

    function setLoading(show, text = '', subtext = '') {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      const loadingSubtext = document.getElementById('loadingSubtext');
      
      if (show) {
        loadingText.textContent = text;
        loadingSubtext.textContent = subtext;
        loadingOverlay.classList.add('active');
      } else {
        loadingOverlay.classList.remove('active');
      }
    }

    function getPeriodDisplayName(periodIndex) {
      const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
      
      const today = new Date();
      let targetMonth = today.getMonth() - periodIndex;
      let targetYear = today.getFullYear();
      
      if (targetMonth < 0) {
        targetMonth += 12;
        targetYear -= 1;
      }
      
      if (periodIndex === 0) return `Current Month (${monthNames[targetMonth]} ${targetYear})`;
      if (periodIndex === 1) return `Last Month (${monthNames[targetMonth]} ${targetYear})`;
      return `Previous Month (${monthNames[targetMonth]} ${targetYear})`;
    }

    // ==================== DATA LOADING FUNCTIONS ====================
    function loadDataForPeriod(periodIndex) {
      setLoading(true, `Loading ${getPeriodDisplayName(periodIndex)}`, 'Processing usage data...');
      
      // Simulate API delay
      setTimeout(() => {
        appState.currentPeriod = periodIndex;
        appState.usageData = SAMPLE_DATA[periodIndex];
        appState.lastFetchTime = new Date();
        
        updateDisplay();
        setLoading(false);
        
        showStatusMessage(`‚úÖ ${getPeriodDisplayName(periodIndex)} data loaded`, 'success');
      }, 800);
    }

    function updateDisplay() {
      if (!appState.usageData) return;
      
      const data = appState.usageData;
      
      // Update last updated time
      const lastUpdatedEl = document.getElementById('lastUpdated');
      lastUpdatedEl.textContent = `Last updated: ${appState.lastFetchTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
      
      // Update period selector
      document.querySelectorAll('.period-option').forEach(option => {
        if (parseInt(option.dataset.period) === appState.currentPeriod) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
      
      // Calculate and update summary
      updateSummary(data);
      
      // Update tables based on current tab
      updateUsersTable(data.users);
      updateResourcesTable(data.resources);
      updateAllServicesTable(data);
    }

    function updateSummary(data) {
      // Calculate totals
      let totalUsers = 0;
      let committedUsers = 0;
      let onDemandUsers = 0;
      
      data.users.forEach(user => {
        totalUsers += user.qty;
        user.items.forEach(item => {
          if (item.name.includes('Committed')) {
            committedUsers += item.qty;
          } else if (item.name.includes('On-Demand')) {
            onDemandUsers += item.qty;
          }
        });
      });
      
      let totalResources = 0;
      let totalUnits = 0;
      let totalMinutes = 0;
      let botFlowUnits = 0;
      let apiRequests = 0;
      
      data.resources.forEach(category => {
        category.items.forEach(resource => {
          totalResources += resource.qty;
          if (resource.unit === 'units') totalUnits += resource.qty;
          if (resource.unit === 'minutes') totalMinutes += resource.qty;
          if (resource.name.includes('Bot Flow')) botFlowUnits = resource.qty;
          if (resource.name.includes('API Resource')) apiRequests = resource.qty;
        });
      });
      
      // Update summary cards
      document.getElementById('totalUsers').textContent = formatNumber(totalUsers);
      document.getElementById('usersDetail').textContent = `Committed: ${formatNumber(committedUsers)} ‚Ä¢ On-Demand: ${formatNumber(onDemandUsers)}`;
      
      document.getElementById('totalResources').textContent = formatNumber(totalResources);
      document.getElementById('resourcesDetail').textContent = `Units: ${formatNumber(totalUnits)} ‚Ä¢ Minutes: ${formatNumber(totalMinutes)}`;
      
      document.getElementById('botFlowUnits').textContent = formatNumber(botFlowUnits);
      document.getElementById('apiRequests').textContent = formatNumber(apiRequests);
    }

    function updateUsersTable(users) {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';
      
      let totalQty = 0;
      
      users.forEach(user => {
        // Main user row
        const mainRow = document.createElement('tr');
        mainRow.className = 'category-header';
        mainRow.innerHTML = `
          <td style="font-weight:700;">${user.name}</td>
          <td class="number-cell" style="font-weight:700;">${formatNumber(user.qty)}</td>
          <td>${user.rate}</td>
          <td class="number-cell">${user.total}</td>
          <td></td>
        `;
        tbody.appendChild(mainRow);
        
        totalQty += user.qty;
        
        // Sub-items
        user.items.forEach(item => {
          const subRow = document.createElement('tr');
          subRow.className = 'sub-item';
          subRow.innerHTML = `
            <td>${item.name}</td>
            <td class="number-cell">${formatNumber(item.qty)}</td>
            <td>${item.rate}</td>
            <td class="number-cell">${item.total}</td>
            <td></td>
          `;
          tbody.appendChild(subRow);
        });
      });
      
      // Total row
      const totalRow = document.createElement('tr');
      totalRow.className = 'total-row';
      totalRow.innerHTML = `
        <td style="font-weight:700;">TOTAL USERS</td>
        <td class="number-cell" style="font-weight:700;">${formatNumber(totalQty)}</td>
        <td></td>
        <td></td>
        <td></td>
      `;
      tbody.appendChild(totalRow);
    }

    function updateResourcesTable(resources) {
      const tbody = document.getElementById('resourcesTableBody');
      tbody.innerHTML = '';
      
      resources.forEach(category => {
        // Category header
        if (category.category) {
          const headerRow = document.createElement('tr');
          headerRow.className = 'category-header';
          headerRow.innerHTML = `
            <td colspan="6" style="font-weight:700;font-size:14px;">${category.category}</td>
          `;
          tbody.appendChild(headerRow);
        }
        
        // Resource items
        category.items.forEach(resource => {
          const row = document.createElement('tr');
          
          const includedText = resource.included.qty > 0 
            ? `${formatNumber(resource.included.qty)}(${formatNumber(resource.included.used)} used)`
            : formatNumber(resource.included.qty);
            
          const actionButton = resource.canCancel 
            ? `<button class="cancel-btn" data-resource="${resource.name}">Cancel</button>`
            : '';
          
          row.innerHTML = `
            <td>${resource.name}</td>
            <td class="number-cell">${formatNumber(resource.qty)}</td>
            <td>${resource.unit}</td>
            <td class="number-cell">${includedText}</td>
            <td class="number-cell">${formatNumber(resource.onDemand)}</td>
            <td>${actionButton}</td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function updateAllServicesTable(data) {
      const tbody = document.getElementById('allServicesTableBody');
      tbody.innerHTML = '';
      
      // Add users as services
      data.users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><span class="status-indicator status-active"></span>User License</td>
          <td>${user.name}</td>
          <td class="number-cell">${formatNumber(user.qty)}</td>
          <td>${user.rate}</td>
          <td class="number-cell">${formatNumber(user.qty)}</td>
          <td class="number-cell">0</td>
          <td><span style="color:var(--success);">‚óè Active</span></td>
        `;
        tbody.appendChild(row);
        
        // Add sub-items
        user.items.forEach(item => {
          const subRow = document.createElement('tr');
          subRow.className = 'indent-1';
          const type = item.name.includes('Committed') ? 'Committed' : 'On-Demand';
          subRow.innerHTML = `
            <td>‚Ü≥ ${type}</td>
            <td>${item.name}</td>
            <td class="number-cell">${formatNumber(item.qty)}</td>
            <td>users</td>
            <td class="number-cell">${type === 'Committed' ? formatNumber(item.qty) : '0'}</td>
            <td class="number-cell">${type === 'On-Demand' ? formatNumber(item.qty) : '0'}</td>
            <td><span style="color:${item.qty > 0 ? 'var(--success)' : 'var(--text-light)'};">${item.qty > 0 ? '‚óè Active' : '‚óã Inactive'}</span></td>
          `;
          tbody.appendChild(subRow);
        });
      });
      
      // Add resources as services
      data.resources.forEach(category => {
        category.items.forEach(resource => {
          const row = document.createElement('tr');
          const serviceType = resource.name.includes('BYOT') ? 'BYOC Cloud' : 
                            resource.name.includes('Bot Flow') ? 'Bot Service' :
                            resource.name.includes('API') ? 'API Service' :
                            resource.name.includes('IVR') ? 'IVR Service' :
                            resource.name.includes('Transcription') ? 'Transcription' :
                            resource.name.includes('SMS') ? 'Messaging' :
                            resource.name.includes('Email') ? 'Email' :
                            resource.name.includes('WhatsApp') ? 'Messaging' :
                            resource.name.includes('Predictive') ? 'Analytics' : 'Resource';
          
          const status = resource.qty > 0 ? 'Active' : 'Inactive';
          const statusColor = resource.qty > 0 ? 'var(--success)' : 'var(--text-light)';
          
          row.innerHTML = `
            <td><span class="status-indicator ${resource.qty > 0 ? 'status-active' : 'status-inactive'}"></span>${serviceType}</td>
            <td>${resource.name}</td>
            <td class="number-cell">${formatNumber(resource.qty)}</td>
            <td>${resource.unit}</td>
            <td class="number-cell">${formatNumber(resource.included.qty)}</td>
            <td class="number-cell">${formatNumber(resource.onDemand)}</td>
            <td><span style="color:${statusColor};">${resource.qty > 0 ? '‚óè Active' : '‚óã Inactive'}</span></td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    // ==================== EXPORT FUNCTIONS ====================
    function exportToCSV() {
      if (!appState.usageData) {
        showStatusMessage('No data to export', 'warn');
        return;
      }
      
      let csv = `Genesys Cloud Usage Data - ${getPeriodDisplayName(appState.currentPeriod)}\n`;
      csv += `Generated,${new Date().toLocaleString()}\n\n`;
      
      // Users section
      csv += 'USERS\n';
      csv += 'Service,Qty,Rate,Total,Type\n';
      
      appState.usageData.users.forEach(user => {
        csv += `"${user.name}",${user.qty},${user.rate},${user.total},Main\n`;
        user.items.forEach(item => {
          csv += `"  ${item.name}",${item.qty},${item.rate},${item.total},Sub-item\n`;
        });
      });
      
      csv += '\nRESOURCES (excludes Cloud Voice charges)\n';
      csv += 'Resource,Qty,Unit,Included,On-Demand,Category\n';
      
      appState.usageData.resources.forEach(category => {
        const catName = category.category || 'Other Resources';
        category.items.forEach(resource => {
          const includedText = resource.included.qty > 0 
            ? `${resource.included.qty}(${resource.included.used} used)`
            : resource.included.qty;
          csv += `"${resource.name}",${resource.qty},${resource.unit},${includedText},${resource.onDemand},"${catName}"\n`;
        });
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_usage_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showStatusMessage('‚úÖ CSV exported successfully', 'success');
    }

    function exportToJSON() {
      if (!appState.usageData) {
        showStatusMessage('No data to export', 'warn');
        return;
      }
      
      const exportData = {
        period: getPeriodDisplayName(appState.currentPeriod),
        periodIndex: appState.currentPeriod,
        generated: new Date().toISOString(),
        data: appState.usageData
      };
      
      const json = JSON.stringify(exportData, null, 2);
      const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_usage_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showStatusMessage('‚úÖ JSON exported successfully', 'success');
    }

    // ==================== EVENT HANDLERS ====================
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          appState.currentTab = tabId;
          
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) content.classList.add('active');
          });
        });
      });
      
      // Period selection
      document.querySelectorAll('.period-option').forEach(option => {
        option.addEventListener('click', function() {
          const periodIndex = parseInt(this.dataset.period);
          loadDataForPeriod(periodIndex);
        });
      });
      
      // Action buttons
      document.getElementById('btnRefresh').addEventListener('click', function() {
        loadDataForPeriod(appState.currentPeriod);
      });
      
      document.getElementById('btnExportCSV').addEventListener('click', exportToCSV);
      document.getElementById('btnExportJSON').addEventListener('click', exportToJSON);
      
      // Cancel buttons in resources table (event delegation)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('cancel-btn')) {
          const resourceName = e.target.dataset.resource;
          if (confirm(`Cancel ${resourceName}?`)) {
            showStatusMessage(`Cancellation requested for ${resourceName}`, 'info');
            // In a real app, you would make an API call here
          }
        }
      });
    }

    // ==================== INITIALIZATION ====================
    function initializeApp() {
      setupEventListeners();
      loadDataForPeriod(0); // Start with current month
      
      // Update organization name
      document.getElementById('orgNameDisplay').textContent = 'JLA Trusted Organization';
    }

    // ==================== START APPLICATION ====================
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
